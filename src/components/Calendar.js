import React, { useState, useEffect } from 'react';
import Calendar from 'react-calendar';
import { apiRequest } from '../utils/api';
import 'react-calendar/dist/Calendar.css';
import '../styles/styles.css';
import '../styles/utils.css';

const CalendarCard = ({ pets }) => {
  const [date, setDate] = useState(new Date()); // Date actuelle ou sÃ©lectionnÃ©e
  const [appointments, setAppointments] = useState([]);  // Liste des Ã©vÃ©nements
  const [showModal, setShowModal] = useState(false);  // ContrÃ´le de la modale
  const [newEvent, setNewEvent] = useState({
    title: '',
    date: '',
    petName: '',
    description: '',
  });
  const [selectedEvent, setSelectedEvent] = useState(null); // DÃ©tails d'un Ã©vÃ©nement sÃ©lectionnÃ©
  const [showUpcoming, setShowUpcoming] = useState(true);
  const [editMode, setEditMode] = useState(false);

  // Fonction pour formater une date au format jj/mm/aaaa
  const formatDate = (date) => {
    return new Intl.DateTimeFormat('fr-FR', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
    }).format(date);
  };

  // GÃ©rer l'ouverture de la modale
  const handleModalOpen = () => {
    setShowModal(true);
  };

  // GÃ©rer la fermeture de la modale
  const handleModalClose = () => {
    setShowModal(false);
    setNewEvent({
            title: '',
            date: '',
            petName: '',
            description: '',
      });
  };

  const handleEventClick = (event) => {
    setSelectedEvent(event);
  };
  
  const handleDetailsModalClose = () => {
    setSelectedEvent(null);
    setNewEvent({
      title: '',
      date: '',
      petName: '',
      description: '',
    });
    setEditMode(false)
  };

  // GÃ©rer le changement de valeurs dans le formulaire
  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setNewEvent((prevState) => ({
      ...prevState,
      [name]: value,
    }));
  };

  // Fonction pour rÃ©cupÃ©rer les Ã©vÃ©nements
  const getEvents = async () => {
    const token = localStorage.getItem('authToken');
    if (!token) {
      alert('Vous devez Ãªtre connectÃ© pour voir les Ã©vÃ©nements.');
      return;
    }

    try {
      const events = await apiRequest('GET', '/api/evenements/', null, token);
      setAppointments(events);
    } catch (error) {
      console.error('Erreur lors de la rÃ©cupÃ©ration des Ã©vÃ©nements:', error);
      alert('Une erreur est survenue lors de la rÃ©cupÃ©ration des Ã©vÃ©nements.');
    }
  };

  // Appel Ã  getEvents au montage du composant
  useEffect(() => {
    getEvents();
  }, []);

  // Fonction pour ajouter un Ã©vÃ©nement
  const addEvent = async (e) => {
    e.preventDefault();
    // eslint-disable-next-line no-unused-vars
    const { title, date, petName, description } = newEvent;
  
    if (!date || !title) {
      alert('Les champs titre et date sont obligatoires');
      return;
    }
  
    const token = localStorage.getItem('authToken');
    if (!token) {
      alert('Vous devez Ãªtre connectÃ© pour ajouter/modifier un contact.');
      return;
    }
  
    try {
      // Effectuer la requÃªte POST pour ajouter l'Ã©vÃ©nement
      const response = await apiRequest('POST', '/api/evenements/add', newEvent, token);
  
      // Ajouter l'Ã©vÃ©nement Ã  appointments (tous les Ã©vÃ©nements)
      setAppointments((prevAppointments) => {
        return [...prevAppointments, response];
      });
  
      // Fermer la modale aprÃ¨s ajout
      handleModalClose();
    } catch (error) {
      console.error('Erreur:', error.response || error);
      alert('Une erreur est survenue lors de l\'ajout de l\'Ã©vÃ©nement');
    }
  };

  // Fonction pour supprimer un Ã©vÃ©nement
  const deleteEvent = async (e) => {  
    e.preventDefault(); // EmpÃªche le comportement par dÃ©faut du formulaire
    
    const token = localStorage.getItem('authToken');
    if (!token) {
      alert('Vous devez Ãªtre connectÃ© pour supprimer un Ã©vÃ©nement.');
      return; // Sortir de la fonction si l'utilisateur n'est pas connectÃ©
    }

    const confirmDelete = window.confirm('ÃŠtes-vous sÃ»r de vouloir supprimer cet Ã©vÃ©nement ?');
    if (!confirmDelete) return; // Si l'utilisateur annule, on arrÃªte la suppression

    try {
      // Effectuer la requÃªte DELETE pour supprimer l'Ã©vÃ©nement
      await apiRequest('DELETE', `/api/evenements/delete/${selectedEvent._id}`, null, token);

      // Mettre Ã  jour la liste des Ã©vÃ©nements aprÃ¨s la suppression
      setAppointments((prevAppointments) =>
        prevAppointments.filter((event) => event._id !== selectedEvent._id)
      );

      // Fermer la modale aprÃ¨s la suppression
      handleDetailsModalClose();
      handleModalClose();
    } catch (error) {
      console.error('Erreur lors de la suppression de l\'Ã©vÃ©nement:', error);
      alert('Une erreur est survenue lors de la suppression de l\'Ã©vÃ©nement.');
    }
  };

  // Fonction pour modifier un Ã©vÃ¨nement
  const updateEvent = async (e) => {
    e.preventDefault(); // EmpÃªche le comportement par dÃ©faut du formulaire

    const token = localStorage.getItem('authToken');
    if (!token) {
      alert('Vous devez Ãªtre connectÃ© pour modifier un Ã©vÃ©nement.');
      return; // Sortir de la fonction si l'utilisateur n'est pas connectÃ©
    }
  
    try {
      // Effectuer la requÃªte PUT pour modifier l'Ã©vÃ©nement
      const updatedEvent = await apiRequest(
        'PUT',
        `/api/evenements/update/${selectedEvent._id}`,
        newEvent,
        token
      );
  
      // Mettre Ã  jour l'Ã©vÃ©nement dans la liste des Ã©vÃ©nements en remplaÃ§ant celui avec le mÃªme _id
      setAppointments((prevAppointments) =>
        prevAppointments.map((event) =>
          event._id === selectedEvent._id ? { ...event, ...updatedEvent } : event
        )
      );
  
      // Fermer la modale aprÃ¨s modification
      handleDetailsModalClose();
      handleModalClose();
      setEditMode(false);
    } catch (error) {
      console.error('Erreur lors de la modification de l\'Ã©vÃ©nement:', error);
      alert('Une erreur est survenue lors de la modification de l\'Ã©vÃ©nement.');
    }
  };
  

  // Filtrer et trier les Ã©vÃ©nements pour les Ã©vÃ©nements passÃ©s et Ã  venir
  const filterEvents = (events, upcoming = true) => {
    const currentDate = new Date();
    
    // Filtrage des Ã©vÃ©nements futurs ou passÃ©s
    const filteredEvents = events.filter((event) => {
      const eventDate = new Date(event.date); // Utiliser la date de l'Ã©vÃ©nement
      
      // Compare si l'Ã©vÃ©nement correspond Ã  la date sÃ©lectionnÃ©e ou Ã  la date du jour
      if (formatDate(currentDate) === formatDate(eventDate)) {
        // eslint-disable-next-line array-callback-return
        return;
      }

      return upcoming ? eventDate > currentDate : eventDate < currentDate;
    });

    // Trier les Ã©vÃ©nements
    return filteredEvents.sort((a, b) => {
      const dateA = new Date(a.date);
      const dateB = new Date(b.date);
      
      return upcoming ? dateA - dateB : dateB - dateA;  // Trier pour les Ã©vÃ©nements futurs ou passÃ©s
    });
  };

  // Ã‰vÃ©nements Ã  venir et passÃ©s
  const upcomingEvents = filterEvents(appointments, true);  
  const pastEvents = filterEvents(appointments, false);  

  // GÃ©rer les Ã©vÃ©nements du jour (selon la date sÃ©lectionnÃ©e)
  const eventsToday = appointments.filter(
    (event) => formatDate(new Date(event.date)) === formatDate(date)
  );

  // GÃ©rer la mise Ã  jour de la date sÃ©lectionnÃ©e
  const handleDateChange = (newDate) => {
    setDate(newDate); // Met Ã  jour la date sÃ©lectionnÃ©e
  };

  const handleEditClick = () => {
    setEditMode(true);
    setNewEvent({
      title: selectedEvent.title,
      date: formatDateForInput(selectedEvent.date),
      petName: selectedEvent.petName,
      description: selectedEvent.description || '',
    });
  };
  

  const formatDateForInput = (date) => {
    const d = new Date(date);
    const year = d.getFullYear();
    const month = (`0${d.getMonth() + 1}`).slice(-2); // Mois en deux chiffres
    const day = (`0${d.getDate()}`).slice(-2); // Jour en deux chiffres
    return `${year}-${month}-${day}`;
  };

  const handleViewEvent = () => {
    // Met Ã  jour la date sÃ©lectionnÃ©e dans le calendrier
    setDate(new Date(selectedEvent.date));
    // Ferme la modale
    handleDetailsModalClose();
  };
  
  
  
  // RÃ©initialiser la date Ã  aujourd'hui
  const resetDate = () => {
    setDate(new Date());
  };

  return (
    <div className="section w-66">
      <div className="section-title">
        <h2>ğŸ“† Ã‰vÃ©nements et Rendez-vous</h2>
        <button className="add-btn" onClick={handleModalOpen}>+</button>
      </div>

      <div className="calendar-card">
        {/* Affichage du calendrier */}
        <Calendar onChange={handleDateChange} value={date} />

        <div className='all-events-section'>
          {/* Section des Ã©vÃ©nements du jour */}
          <div className="events-today-section">
            <h3>Ã‰vÃ©nement{eventsToday.length <= 1 ? '' : 's'} {formatDate(date) === formatDate(new Date()) ? "aujourd'hui" : `du ${formatDate(date)}`}</h3>
            <ul>
              {eventsToday.length === 0 ? (
                <li>Aucun Ã©vÃ©nement. ğŸ˜´</li>
              ) : (
                eventsToday.map((event, index) => (
                  <li key={index} className='event-resume' onClick={() => handleEventClick(event)}>
                    {event.title} {event.petName ? event.petName : ''} <br></br>
                    <span className='event-description-visible'>{event.description ? event.description : '' }</span>
                  </li>
                ))
              )}
            </ul>
          </div>

          {/* Section des rendez-vous Ã  venir / passÃ©s */}
          <div className="upcoming-events-section">
            <div className="event-toggle">
              <button
                className={showUpcoming ? 'active' : ''}
                onClick={() => setShowUpcoming(true)}
              >
                Ã  venir
              </button>
              <button
                className={!showUpcoming ? 'active' : ''}
                onClick={() => setShowUpcoming(false)}
              >
                passÃ©s
              </button>
            </div>
            <ul>
              {(showUpcoming ? upcomingEvents : pastEvents).length === 0 ? (
                <li>Aucun rendez-vous pour cette pÃ©riode.</li>
              ) : (
                (showUpcoming ? upcomingEvents : pastEvents).map((event, index) => (
                  <li className='event-resume' key={index} onClick={() => handleEventClick(event)}>
                    <strong>{formatDate(new Date(event.date))}</strong> - {event.title}&nbsp;{event.petName ? event.petName : ''} {event.description ? <span className='event-description'>+</span> : '' }
                  </li>
                ))
              )}
            </ul>
          </div>

          {formatDate(date) === formatDate(new Date()) ? '' :
            <button className='btn reset' onClick={resetDate}>Aujourd'hui</button>
          }
        </div>
      </div>

      {/* Modale pour ajouter un Ã©vÃ©nement */}
      {showModal && (
        <div className="modal-overlay">
          <div className="modal-content">
            <h3>Ajouter un Ã©vÃ©nement</h3>
            <button className="canceled-form-btn" tabIndex="0" onClick={handleModalClose} aria-label="Fermer la modale" >X</button>
            <form className='form-event' onSubmit={addEvent}>
              <input
                type="text"
                name="title"
                placeholder="Titre de l'Ã©vÃ¨nement"
                value={newEvent.title}
                onChange={handleInputChange}
                required 
              />
              <input
                type="date"
                name="date"
                value={newEvent.date}
                onChange={handleInputChange}
                required
                placeholder="Date de l'Ã©vÃ¨nement"
              />
              <div className='select-input-gab'>
                <p>Choisir un animal: </p>
                <select
                  name="petName"
                  value={newEvent.petName}
                  onChange={handleInputChange}
                >
                  <option value="">SÃ©lectionner un animal</option>
                  {pets.map((pet) => (
                    <option key={pet._id} value={pet._id}>
                      {pet.name}
                    </option>
                  ))}
                </select>
              </div>
              <textarea
                name="description"
                value={newEvent.description}
                onChange={handleInputChange}
                placeholder="Description de l'Ã©vÃ¨nement"
              />
              <button type="submit">Ajouter</button>
            </form>
          </div>
        </div>
      )}

      {/* DÃ©tails d'un Ã©vÃ©nement sÃ©lectionnÃ© */}
      {selectedEvent && (
        <div className="modal-overlay">
          <div className="modal-content">
            <button className="canceled-form-btn" tabIndex="0" onClick={handleDetailsModalClose} aria-label="Fermer la modale" >X</button>
            {!editMode ? (
              <>
                <h3>{selectedEvent.title}</h3>
                <div style={{display:'flex',justifyContent:'flex-start'}}>
                  <p>Date : {formatDate(new Date(selectedEvent.date))}</p>
                  <button id="event" className="btn" onClick={handleViewEvent}>Voir l'Ã©vÃ©nement</button>
                </div>
                {selectedEvent.petName ? <p>Pour : {selectedEvent.petName}</p> : '' }
                {selectedEvent.description ? <p>Description : {selectedEvent.description}</p> : '' }
                <div className='btn-event-gab'>
                  <button className="edit" onClick={handleEditClick}>Modifier</button>
                  <button className="delete" onClick={deleteEvent}>Supprimer</button>
                </div>
              </>
            ) : (
              <>
                <h3>Modifier l'Ã©vÃ©nement</h3>
                <form className='form-event' onSubmit={updateEvent}>
                  <input type="text"
                    name="title"
                    value={newEvent.title}
                    onChange={handleInputChange}
                    required
                    placeholder="Titre de l'Ã©vÃ¨nement"
                  />
                  <input type="date"
                    name="date"
                    value={formatDateForInput(newEvent.date)}
                    onChange={handleInputChange}
                    required
                  />
                  <div className='select-input-gab'>
                    <label htmlFor="petName">Choisir un animal:</label>
                    <select
                      name="petName"
                      value={newEvent.petName}
                      onChange={handleInputChange}
                    >
                      <option value="">SÃ©lectionner un animal</option>
                      {pets.map((pet) => (
                        <option key={pet._id} value={pet.name}>
                          {pet.name}
                        </option>
                      ))}
                    </select>
                  </div>
                  <textarea
                    name="description"
                    value={newEvent.description}
                    onChange={handleInputChange}
                  />
                  <button type="submit">Valider</button>
                </form>
              </>
            )}
          </div>
        </div>
      )}
    </div>
  );
};

export default CalendarCard;